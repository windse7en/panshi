// for the index calendar showing
var modal_shown = false;
var event_array = [];

//load te fullcalendar from the documents is readay.
// bind the show modal event into calender
$(document).ready(function() {
	console.log('Calendar starts');
	$('#calendar').fullCalendar({
        // put your options and callbacks here
        header: {
				left: 'prev,next today',
				center: 'title',
				right: 'month,agendaWeek,agendaDay'
			},
        theme: true,	// set the theme of the calendar
        defaultDate: '2014-09-12',
        editable: true,
     	eventLimit: true, // allow "more" link when too many events
        weekends: false, // will hide Saturdays and Sundays
        lang: 'zh-cn',	// set language to Simplicity Chinese
        dayClick: function(date, allDay, jsEvent, view) {
            // if (!allDay) {
                // Clicked on the entire day
                $('#calendar').fullCalendar('changeView', 'agendaDay'/* or 'basicDay' */);
                $('#calendar').fullCalendar('gotoDate', date);
            // }
        },
        eventClick: function(calEvent, jsEvent, view) {
            console.log(jsEvent);
            event_open_modal(calEvent);

        },
        viewRender: function(view, element) { 
            // alert('new view: ' + view.name); console.log(view); console.log(element); 
        }
    });

  $('#eventCalendar').on('shown.bs.modal', function (e) {
  		// do something...
  		if(modal_shown == false) {
	  		console.log('modal has been shown');
	  		$('#calendar').fullCalendar('today');
	  		modal_shown = true;
            init();
	  	}
	});
});

// init the calendar, loading all the events.
function init() {
    $.ajax({
        url: "/init_event",
        type: "post",
        success: function( data ){
            while (data.length != 0) {
                var temp = data.pop();
                console.log(temp);
                var event_temp = {event_comment: temp.event_comment, title:temp.product_name, start:temp.reserve_start_at, end: temp.reserve_end_at, id: temp.id, product_name: temp.product_name, employee_name: temp.employee_name, customer_name: temp.customer_name}; 
                $('#calendar').fullCalendar( 'renderEvent', event_temp, true );       // render the new events
                event_array.push(event_temp);
            }
        } 
    });
}

function event_open_modal (calEvent) {
    var modal = $("#common-modal.modal");
    var modal_body = modal.find(".modal-body");
    var modal_content_container_to_populate = "<div class='form-horizontal'>\
            <div class='form-group'>\
              <div class='col-sm-2'>\
                <label for='inputProduct' class='control-label'>预约安排</label>\
              </div>\
              <div class='col-sm-10'>\
                <input id='selectProduct' type='text' class='form-control'></input>\
              </div>\
            </div>\
            <div class='form-group'>\
              <div class='col-sm-2'>\
                <label for='inputEmployee' class='control-label'>预约员工</label>\
              </div>\
              <div class='col-sm-10'>\
                <input id='selectEmployee' type='text' class='form-control'></input>\
              </div>\
            </div>\
            <div class='form-group'>\
              <div class='col-sm-2'>\
                <label for='inputCustomer' class='control-label'>预约顾客</label>\
              </div>\
              <div class='col-sm-10'>\
                <input id='selectCustomer' type='text' class='form-control'></input>\
              </div>\
            </div>\
            <div class='form-group'>\
              <div class='col-sm-2'>\
                <label for='inputDate' class='control-label'>预约日期</label>\
              </div>\
              <div class='col-sm-10'>\
                <input type='date' class='form-control' id='inputDate'>\
              </div>\
            </div>\
            <div class='form-group'>\
              <div class='col-sm-2'>\
                <label for='inputStart' class='control-label'>开始时间</label>\
              </div>\
              <div class='col-sm-10'>\
                <input id='inputTimeStart' type='text' class='form-control time ui-timepicker-input' autocomplete='off'>\
              </div>\
            </div>\
            <div class='form-group'>\
              <div class='col-sm-2'>\
                <label for='inputEnd' class='control-label'>结束时间</label>\
              </div>\
              <div class='col-sm-10'>\
                <input id='inputTimeEnd' type='text' class='form-control time ui-timepicker-input' autocomplete='off'>\
              </div>\
            </div>\
            <div class='form-group'>\
              <div class='col-sm-2'>\
                <label for='inputComment' class='control-label'>预约备注</label>\
              </div>\
              <div class='col-sm-10'>\
                <textarea id='inputComment' class='form-control' cols='40' rows='5'></textarea>\
              </div>\
            </div>\
          </div>";

        // if modal and content container exists
    if (modal_body.length > 0 && modal_content_container_to_populate.length > 0)
    {
        // fade out main content of page (so modal content is readable)
        $("#outer-container").fadeTo("fast",0.2);

        // get initial vertical offset so that when modal is opened/closed, it ensures that page doesn't scroll to top (bugfix)
        var initial_vertical_scroll_offset = $(document).scrollTop();

        var modal_content = modal_content_container_to_populate; // get content to populate in modal
        modal_body.empty().html(modal_content); // first empty the modal body and then populate it with new content
        $("#inputDate").val(calEvent.start._i.substring(0,10));
        $('#inputTimeStart').val(calEvent.start._i.substring(11,19));
        $('#inputTimeEnd').val(calEvent.end._i.substring(11,19));
        $('#inputTimeStart').timepicker({ 'timeFormat': 'H:i:s', 'minTime': '09:00:00', 'maxTime': '20:00:00', 'showDuration': true });
        $('#inputTimeEnd').timepicker({ 'timeFormat': 'H:i:s', 'minTime': '09:00:00', 'maxTime': '20:00:00', 'showDuration': true });
        $('textarea#inputComment').val(calEvent.event_comment);

        $('#selectProduct').val(calEvent.product_name);
        $('#selectEmployee').val(calEvent.employee_name);
        $('#selectCustomer').val(calEvent.customer_name);




        // open modal (popup)
        modal.modal(); 

        // when modal is shown, position it in the middle of the page 
        modal.on('shown.bs.modal', function (e) {
            // position_modal_at_centre();
        });

        // when modal starts to close, fade in main content 
        modal.on('hide.bs.modal', function (e) {
            $("#outer-container").fadeTo("fast",1);
        });

        // when modal is hidden, empty modal body 
        modal.on('hidden.bs.modal', function (e) {
            modal_body.empty(); // empty modal body
        }); 
    }
    $('#common-modal').modal('show');
}

